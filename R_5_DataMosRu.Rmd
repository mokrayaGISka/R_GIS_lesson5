---
title: '–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Å data.mos.ru'
author: "by üåç"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(data.table)
library(tidyr)
library(sp)
library(sf)
library(stringr)
library(spData)
library(tmap)
library(httr)
library(mapview)
library(tmap)

```


## –ü–æ—Ä—Ç–∞–ª –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –ú–æ—Å–∫–≤—ã 
#### [https://data.mos.ru](https://data.mos.ru) —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ 100 —Ç–µ–º–∞—Ç–∏—á–µc–∫–∏—Ö –Ω–∞–±–æ—Ä–æ–≤, –º–Ω–æ–≥–∏–µ –∏–∑ –Ω–∏—Ö —Å –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µc–∫–æ–π –ø—Ä–∏–≤—è–∑–∫–æ–π


![–°–∞–π—Ç –ø–æ—Ä—Ç–∞–ª–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö](datamos.png)



## –í–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

#### 1. –ù–∞–ø—Ä—è–º—É—é —Å [–ø–æ—Ä—Ç–∞–ª–∞](https://data.mos.ru) -  xlsx, json, xml


####  2. –ß–µ—Ä–µ–∑ API - geojson

-–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ª—É—á–∏—Ç—å API –Ω–∞ —Å–∞–π—Ç–µ [https://apidata.mos.ru](https://apidata.mos.ru)
-—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ (—á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä, —á–µ—Ä–µ–∑ R...)

#### 3. [–£—Ç–∏–ª–∏—Ç–∞ –æ—Ç Urbica](https://github.com/urbica/datamos-geojson)

-—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js: https://nodejs.org/

-—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ç–∏–ª–∏—Ç—É, –≤—ã–ø–æ–ª–Ω–∏–≤  `npm install -g datamos-geojson` –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    
-–∑–∞–ø—É—Å—Ç–∏—Ç—å —É—Ç–∏–ª–∏—Ç—É, –≤—ã–ø–æ–ª–Ω–∏–≤ `datamos-geojson` –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ 


## –ö–∞–∫ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É—è API

#### 1.–ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è

https://apidata.mos.ru/v1/datasets/{DatasetId}/features?api_key={–ö–õ–Æ–ß_API}


#### 2. –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è, –æ–±—Ä–µ–∑–∞–Ω–Ω–∞—è –ø–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–µ–º—É –∫–æ–Ω—Ç—É—Ä—É (bbox)

http://api.data.mos.ru/v1/datasets/{DatasetId}/features?bbox={bbox}&api_key={–ö–õ–Æ–ß_API}


#### 3.–ü—Ä–æ—à–ª—ã–µ –≤–µ—Ä—Å–∏–∏

https://apidata.mos.ru/v1/datasets/{DatasetId}/features?versionNumber={VersionNumber}&releaseNumber={ReleaseNumber}&api_key={–ö–õ–Æ–ß_API}


##  –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –¥–∞—Ç–∞—Å–µ—Ç–∞ –∏ –∫–ª—é—á API

```{r set parameters, results = "hide", message = FALSE}

datasetId = "1193" #–Ω–æ–º–µ—Ä –¥–∞—Ç–∞—Å–µ—Ç–∞, –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –≤ –ø–∞—Å–ø–æ—Ä—Ç–µ

#version = "1" #–Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    
#release = "59" #–Ω–æ–º–µ—Ä —Ä–µ–ª–∏–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

api_key = "b0c0ad1adf1319a3a8b1c2ed7649b21e"  #—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á API
```


## –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Å—ã–ª–∫–µ

```{r get_data, results = "hide", message = FALSE}

url = paste0("https://apidata.mos.ru/v1/datasets/", datasetId,"/features?api_key=",api_key) # —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏

data_sf = url %>% st_read() #—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ json
        
```

## C–º–æ—Ç—Ä–∏–º

```{r view_data, message = FALSE}

mapview(data_sf)        
        
```

## –í –æ–¥–Ω–æ–π –∏–∑ –∫–æ–ª–æ–Ω–æ–∫ —Ö–∞–æ—Å - –Ω–µ–ø–æ—Ä—è–¥–æ–∫ ;)

## –ê—Ç—Ä–∏–±—É—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã

```{r edit_data, message = FALSE}

data_json = url %>% readr::read_file() %>% iconv("UTF-8")

data_json_edited = mgsub::mgsub(data_json, c('\\\"Attributes\\\":\\{', '\\}\\,\"type\":\"Feature\"\\}'), c('','\\,\"type\"\\:\"Feature\"\\}')) #—É–¥–∞–ª—è–µ–º Attributes –∫–∞–∫ –≥—Ä—É–ø–ø—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ –º–Ω–æ–∂–µ—Ç—Å–≤–æ —Ä–∞–∑–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ 

data_sf2 = data_json_edited %>% sf::read_sf() #—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ json
                
glimpse(data_sf2)  #—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Å—Ç—Ä–∫—É—Ç—Ä—É –ø–æ–ª—É—á–∏–≤—à–µ–≥–æ—Å—è —Ñ–∞–π–ª–∞

mapview(data_sf2)  # —Å–º–æ—Ç—Ä–∏–º –Ω–∞ –¥–∞–Ω–Ω—ã–µ

```



## –§—É–Ω–∫—Ü–∏—è, —Å –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä–æ–π —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö

```{r create function to get data }

get_datamos = function(datasetId) {
  
url = paste0("https://apidata.mos.ru/v1/datasets/", datasetId,"/features?api_key=","b0c0ad1adf1319a3a8b1c2ed7649b21e")
  
data_json = url %>% readr::read_file() %>% iconv("UTF-8")

data_json_edited = mgsub::mgsub(data_json, c('\\\"Attributes\\\":\\{', '\\}\\,\"type\":\"Feature\"\\}'), c('','\\,\"type\"\\:\"Feature\"\\}')) #—É–¥–∞–ª—è–µ–º Attributes –∫–∞–∫ –≥—Ä—É–ø–ø—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ –º–Ω–æ–∂–µ—Ç—Å–≤–æ —Ä–∞–∑–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ 

data_sf = data_json_edited %>% sf::read_sf()
 
return(data_sf)
}

#–ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ get_datamos
vet = get_datamos(1193)
mapview(vet)

```


## –í—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã
![](Sport.png){width=150px}

```{r call needed datasets}

ids = c(890, 60623, 1387, 886, 60624, 885,	902, 1232, 629) #–Ω–æ–º–µ—Ä–∞ –Ω—É–∂–Ω—ã—Ö –Ω–∞–º –¥–∞—Ç–∞—Å–µ—Ç–æ–≤

sets_names = c("Waterpools", "Tennis", "Climbing", "Football", "Gym", "Regby", "Equestrian", "Ice skating", "SportHalls") #–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—è


```


## –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏ –∂–¥—ë–º
![](ask.jpg){width=150px}


```{r get all datasets, results = "hide"}

#one_dataset = get_datamos(datasetId) # –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫ –æ–¥–Ω–æ–º—É –ª—é–±–æ–º—É –¥–∞—Ç–∞—Å–µ—Ç—É

datasets = lapply(ids, get_datamos) # –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ get_datamos –∫–æ –≤—Å–µ–º –Ω—É–∂–Ω—ã–º –Ω–∞–º –¥–∞—Ç–∞–µ—Å—Ç–∞–º 

names(datasets) <- sets_names # –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞

```

## –°–º–æ—Ç—Ä–∏–º

```{r creating maps, message = FALSE}

# –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É —Å –ø–æ–º–æ—â—å—é tmap —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–ª–æ–µ–≤

colors = c("aquamarine2","yellowgreen","lightskyblue3","maroon3","tan1") # —Ü–≤–µ—Ç–∞, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–µ—Å–µ–ª–µ–µ

sport_data = 0
for (i in 1:length(datasets)) {
  sport_data = sport_data+ tm_shape(datasets[[i]]) + tm_bubbles(group = sets_names[i], size = 0.1, col = colors[i]) 
} 

tmap_mode("view") # –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º tmap

sport_data %>% tmap_leaflet() %>% leaflet::hideGroup(sets_names[-1]) # –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–∞—Ä—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º leaflet –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–ª–æ–µ–≤

```


